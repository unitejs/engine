/**
 * Gulp tasks for serving site.
 */
const browserSync = require("browser-sync");
const gulp = require("gulp");
const minimist = require("minimist");
const path = require("path");
const runSequence = require("run-sequence");
const util = require("util");
const envUtil = require("../../util/env-util");
const uc = require("../../util/unite-config");
let browserSyncInstance = null;
gulp.task("serve", async () => {
    const knownOptions = {
        default: {
            secure: false,
            port: "9000"
        },
        boolean: [
            "secure"
        ],
        string: [
            "port"
        ]
    };
    const options = minimist(process.argv.slice(2), knownOptions);
    const uniteConfig = await uc.getUniteConfig();
    envUtil.set("transpileContinueOnError", true);
    gulp.watch(path.join(uniteConfig.dirs.www.src, `**/*.${uc.extensionMap(uniteConfig.sourceExtensions)}`), () => {
        require("./build");
        runSequence("build-src-all", "serve-reload");
    });
    gulp.watch(path.join(uniteConfig.dirs.www.src, `**/*.${uc.extensionMap(uniteConfig.viewExtensions)}`), () => {
        require("./build");
        runSequence("build-src-view-all", "serve-reload");
    });
    gulp.watch(path.join(uniteConfig.dirs.www.src, `**/*.${uniteConfig.styleExtension}`), () => {
        require("./build");
        runSequence("build-src-style-all", "serve-reload");
    });
    gulp.watch(path.join(uniteConfig.dirs.www.cssSrc, `**/*.${uniteConfig.styleExtension}`), () => {
        require("./build");
        runSequence("build-css-all", "serve-reload");
    });
    browserSyncInstance = browserSync.create();
    const initAsync = util.promisify(browserSyncInstance.init);
    return initAsync({
        https: options.secure,
        online: true,
        open: true,
        port: options.port,
        server: {
            baseDir: ["."]
        },
        reloadDebounce: 2000
    });
});
gulp.task("serve-reload", () => {
    if (browserSyncInstance) {
        browserSyncInstance.reload();
    }
});
// Generated by UniteJS
